<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Portfolio Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        .dashboard-title {
            color: #2c3e50;
            margin: 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .chart-container {
            min-height: 400px;
        }
        .summary-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .summary-label {
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="dashboard-title">Investment Portfolio Dashboard</h1>
        
        <!-- Summary Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="summary-box">
                    <div class="summary-value" id="totalValue">$0.00</div>
                    <div class="summary-label">Total Portfolio Value</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-box">
                    <div class="summary-value" id="totalGain">$0.00</div>
                    <div class="summary-label">Total Gain/Loss</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-box">
                    <div class="summary-value" id="dayChange">$0.00</div>
                    <div class="summary-label">Day's Change</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-box">
                    <div class="summary-value" id="cashBalance">$0.00</div>
                    <div class="summary-label">Cash Balance</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <!-- Asset Allocation -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Asset Allocation
                    </div>
                    <div class="card-body chart-container">
                        <div id="portfolioOverview"></div>
                    </div>
                </div>
            </div>
            
            <!-- Stock Distribution -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Holdings Distribution
                    </div>
                    <div class="card-body chart-container">
                        <div id="stockDistribution"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Holdings Table -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Current Holdings
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="holdingsTable">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Market Value</th>
                                        <th>Cost Basis</th>
                                        <th>Gain/Loss</th>
                                        <th>% of Portfolio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        function formatNumber(value) {
            if (value === null || value === undefined || isNaN(value)) return '0';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return '0.00%';
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value / 100);
        }

        function updateSummary() {
            fetch('/api/portfolio_summary')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalValue').textContent = formatCurrency(data.total_value);
                    document.getElementById('totalGain').textContent = formatCurrency(data.total_gain);
                    document.getElementById('dayChange').textContent = formatCurrency(data.day_change);
                    document.getElementById('cashBalance').textContent = formatCurrency(data.cash_balance);
                    
                    // Update colors for gain/loss
                    const totalGainElement = document.getElementById('totalGain');
                    totalGainElement.style.color = data.total_gain >= 0 ? '#28a745' : '#dc3545';
                    
                    const dayChangeElement = document.getElementById('dayChange');
                    dayChangeElement.style.color = data.day_change >= 0 ? '#28a745' : '#dc3545';
                });
        }

        function updateHoldingsTable() {
            fetch('/api/holdings')
                .then(response => response.json())
                .then(data => {
                    console.log('Holdings data:', data);  // Debug log
                    const tbody = document.querySelector('#holdingsTable tbody');
                    tbody.innerHTML = '';
                    
                    if (!Array.isArray(data) || data.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="8" class="text-center">No holdings data available</td>';
                        tbody.appendChild(row);
                        return;
                    }
                    
                    // First add Account Total row with a different style
                    const accountTotal = data.find(h => h.type === 'Account Total');
                    if (accountTotal) {
                        const totalRow = document.createElement('tr');
                        totalRow.className = 'table-secondary fw-bold';
                        totalRow.innerHTML = `
                            <td>${accountTotal.symbol}</td>
                            <td>${accountTotal.description}</td>
                            <td class="text-end">-</td>
                            <td class="text-end">-</td>
                            <td class="text-end">${formatCurrency(accountTotal.value)}</td>
                            <td class="text-end">${formatCurrency(accountTotal.cost_basis)}</td>
                            <td class="text-end" style="color: ${accountTotal.gain_loss >= 0 ? '#28a745' : '#dc3545'}">
                                ${formatCurrency(accountTotal.gain_loss)}
                            </td>
                            <td class="text-end">${formatPercent(accountTotal.portfolio_percentage)}</td>
                        `;
                        tbody.appendChild(totalRow);
                        
                        // Add a separator row
                        const separatorRow = document.createElement('tr');
                        separatorRow.innerHTML = '<td colspan="8" class="p-0"><hr class="my-2"></td>';
                        tbody.appendChild(separatorRow);
                    }
                    
                    // Then add individual positions
                    data.filter(h => h.type !== 'Account Total')
                        .sort((a, b) => b.value - a.value)
                        .forEach(holding => {
                            const row = document.createElement('tr');
                            const gainLossColor = holding.gain_loss >= 0 ? '#28a745' : '#dc3545';
                            
                            row.innerHTML = `
                                <td><strong>${holding.symbol || ''}</strong></td>
                                <td>${holding.description || ''}</td>
                                <td class="text-end">${formatNumber(holding.quantity)}</td>
                                <td class="text-end">${formatCurrency(holding.price)}</td>
                                <td class="text-end">${formatCurrency(holding.value)}</td>
                                <td class="text-end">${formatCurrency(holding.cost_basis)}</td>
                                <td class="text-end" style="color: ${gainLossColor}">
                                    ${formatCurrency(holding.gain_loss)}
                                </td>
                                <td class="text-end">${formatPercent(holding.portfolio_percentage)}</td>
                            `;
                            tbody.appendChild(row);
                        });
                })
                .catch(error => {
                    console.error('Error fetching holdings:', error);
                    const tbody = document.querySelector('#holdingsTable tbody');
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading holdings data</td></tr>';
                });
        }

        // Load all data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load Portfolio Overview
            fetch('/api/portfolio_overview')
                .then(response => response.json())
                .then(data => {
                    Plotly.newPlot('portfolioOverview', JSON.parse(data));
                })
                .catch(error => console.error('Error loading portfolio overview:', error));

            // Load Stock Distribution
            fetch('/api/stock_distribution')
                .then(response => response.json())
                .then(data => {
                    Plotly.newPlot('stockDistribution', JSON.parse(data));
                })
                .catch(error => console.error('Error loading stock distribution:', error));

            // Update summary and holdings table
            updateSummary();
            updateHoldingsTable();

            // Set up automatic refresh every 5 minutes
            setInterval(() => {
                updateSummary();
                updateHoldingsTable();
            }, 300000);
        });
    </script>
</body>
</html> 